<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>
  <head>
    <%= javascript_include_merged :base %>
    <%= javascript_include_merged :tt %>

    <%= stylesheet_link_merged :tt %>

    <%= stylesheet_link_tag "print", { :media => "print" } %>
    <%= auto_discovery_link_tag(:rss, {:controller => 'feeds', :action => 'rss', :id => session[:user].uuid }) %>

    <title><%= controller.controller_name + " / " + controller.action_name %></title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<% @internal = Customer.find(:first, :conditions => ["(name = 'Internal' or name = ?) AND company_id = ?", session[:user].company.name, session[:user].company.id]) %>

<% if session[:project] && session[:project].customer.css && session[:project].customer.css.length > 0 %>

<style type="text/css">
<%= session[:project].customer.css %>
</style>

<% elsif !@internal.nil? && !@internal.css.nil? && @internal.css.length > 0 %>

<style type="text/css">
<%= @internal.css %>
</style>

<% end %>

  </head>

  <body id="body" style="height:100%;">
    <div id="loading" style="z-index: 1000; position:absolute; right: 10px; top: 10px; width:70px; height:20px; color: white; padding:6px; display: none; "><img src="/images/spinner.gif" border="0"></div>
    <div id="tip" style="position:absolute;top:250px;left:250px;visibility:hidden;color:#666666;z-index:60;"><table border="0"><tr><td style="background-color:#ffffff;color:#666666;border:1px solid #CCCCCC;padding:0.2em;" id="message"><br/></td></tr></table></div>
    <table width="100%" cellspacing="0" cellpadding="0">
      <tr>
        <td colspan="2">
          <div id="menu">
              <%= render(:partial => "layouts/menu") %>
          </div>

          <table width="100%" cellpadding=0 cellspacing=0 border=0  style="margin-top:0.5em;">
            <tr>
              <td valign=bottom style="padding-left:0px;" width="100%">
              <%= start_form_tag( {:controller => 'search', :action => 'search'}, {:method => 'get'})  %>
              <div id="globalMenu" width="100%">
              <div id="menucontainer" width="100%">
              <div id="tabmenu" width="100%">
              <ul>
                <% if session[:user].seen_welcome.to_i == 0 %>
                  <% if controller.controller_name == "activities" && controller.action_name == 'welcome' %>
                  <li><%= link_to "<span class=\"active\">#{_('Tutorial')}</span>", { :controller => 'activities', :action => 'welcome'}, :class => "active"%></li>
                  <% else %>
                  <li><%= link_to "<span>#{_('Tutorial')}</span>", { :controller => 'activities', :action => 'welcome'} %></li>
                  <% end %>
                <% end %>

                <% if controller.controller_name == "activities" && controller.action_name != 'welcome' %>
                        <li><%= link_to "<span class=\"active\">#{_('Overview') }</span>", { :controller => 'activities', :action => 'list'}, :class => "active"%></li>
                <% else %>
                <li><%= link_to "<span>#{_('Overview')}</span>", { :controller => 'activities', :action => 'list'} %></li>
                <% end %>

                <% if controller.controller_name == "tasks" && !['timeline', 'new'].include?(controller.action_name) %>
                <li><%= link_to "<span class=\"active\">#{_('Browse')}</span>", { :controller => 'views', :action => 'browse'}, :class => "active" %></li>
                <% else %>
                <li><%= link_to "<span>#{_('Browse')}</span>", :controller => 'views', :action => 'browse' %></li>
                <% end %>

                <% if session[:user].option_tracktime == 1%>
                  <% if controller.controller_name == "timeline" && controller.action_name == "list" %>
                  <li><%= link_to "<span class=\"active\">#{_('Timeline')}</span>", { :controller => 'timeline', :action => 'list'}, :class => "active" %></li>
                  <% else %>
                  <li><%= link_to "<span>#{_('Timeline')}</span>", :controller => 'timeline', :action => 'list' %></li>
                  <% end %>
                <% end %>

                <% if controller.controller_name == "project_files"  %>
                <li><%= link_to "<span class=\"active\">#{_('Files')}</span>", {:controller => 'project_files', :action => 'list'}, :class => "active" %> </li>
                <% else %>
                <li><%= link_to "<span>#{_('Files')}</span>", :controller => 'project_files', :action => 'list' %> </li>
                <% end %>

                <% if session[:user].option_tracktime == 1%>
                  <% if controller.controller_name == "reports"  %>
                  <li><%= link_to "<span class=\"active\">#{_('Reports')}</span>", {:controller => 'reports', :action => 'list'}, :class => "active" %></li>
                  <% else %>
                  <li><%= link_to "<span>#{_('Reports')}</span>", :controller => 'reports', :action => 'list' %></li>
                  <% end %>
                <% end %>

                <% if controller.controller_name == "schedule"  %>
                <li><%= link_to "<span class=\"active\">#{_('Schedule')}</span>", {:controller => 'schedule', :action => 'list'}, :class => "active" %></li>
                <% else %>
                <li><%= link_to "<span>#{_('Schedule')}</span>", :controller => 'schedule', :action => 'list' %></li>
                <% end %>

                <% if controller.controller_name == "wiki"  %>
                <li><%= link_to "<span class=\"active\">#{_('Wiki')}</span>", {:controller => 'wiki', :action => 'show'}, :class => "active" %></li>
                <% else %>
                <li><%= link_to "<span>#{_('Wiki')}</span>", :controller => 'wiki', :action => 'show' %></li>
                <% end %>


                <% if controller.controller_name == "tasks" && controller.action_name == 'new'  %>
                <li><%= link_to "<span class=\"active\">#{_('New')}</span>", {:controller => 'tasks', :action => 'new'}, :class => "active" %> </li>
                <% else %>
                <li><%= link_to "<span>#{_('New Task')}</span>", :controller => 'tasks', :action => 'new' %> </li>
                <% end %>

                <li class="right"><%= link_to "<span class=\"last\">#{_('Log Out')}</span>", { :controller => 'login', :action => 'logout'}, :class => "right" %></li>
                <% if controller.controller_name == "users" && controller.action_name == "edit_preferences" %>
                <li class="right"><%= link_to "<span class=\"right active\">#{_('Preferences')}</span>", { :controller => 'users', :action => 'edit_preferences'}, :class => "right active"%></li>
                <% else %>
                <li class="right"><%= link_to "<span class=\"right\">#{_('Preferences')}</span>", { :controller => 'users', :action => 'edit_preferences'}, :class => "right" %></li>
                <% end %>

                <% if session[:user].admin > 0 %>

                <% if session[:user].option_externalclients == 1%>
                <% if controller.controller_name == "customers" %>
                  <li class="right"><%= link_to "<span class=\"active\">#{_('Clients')}</span>", { :controller => 'customers', :action => 'list'}, :class => "active"%></li>
                  <% else %>
                  <li class="right"><%= link_to "<span class=\"right\">#{_('Clients')}</span>", { :controller => 'customers', :action => 'list'}, :class => "right" %></li>
                <% end %>
                <% end %>


                <% if controller.controller_name == "users" && controller.action_name != "edit_preferences" %>
                   <li class="right"><%= link_to "<span class=\"right active\">#{_('Users')}</span>", { :controller => 'users', :action => 'list'}, :class => "right active"%></li>
                <% else %>
                   <li class="right"><%= link_to "<span class=\"right\">#{_('Users')}</span>", { :controller => 'users', :action => 'list'}, :class => "right" %></li>
                <% end %>

                <% end %>

                  <li class="right" id="search_menu"><span class="right"><%=_ 'Search' %> <%= text_field_tag 'query', "", {:size => 10, :style => "font-size:9px;"}%></span></li>

                </ul>
              </div>
              </div>
              </div>
                <%= end_form_tag %>

              </td>
            </tr>
            </table>

          </td>
      </tr>
      <tr><td colspan="2" height="10px">&nbsp;</td></tr>

      <tr>
        <td valign="top" width="100%" class="rounded_content">

        <% if session[:user].respond_to?(:seen_news_id)%>
          <% news = NewsItem.find(:first, :order => "created_at desc", :conditions => ["id > ?", session[:user].seen_news_id ]) %>
          <% unless news.nil? %>
            <div id="news">
              <div  class="rounded_content_body" style="margin-left: 4px; margin-right: 4px; padding-top: 0pt;"><div style="background-color: rgb(238, 238, 238);"><span style="border-color: rgb(238, 238, 238); border-width: 1px 2px 0px; border-top: 1px solid rgb(238, 238, 238); overflow: hidden; background-color: rgb(255, 255, 255); display: block; height: 0px; font-size: 1px; margin-left: 3px; margin-right: 3px;"></span><span style="border-style: solid; border-color: rgb(238, 238, 238); border-width: 0px 1px; overflow: hidden; background-color: rgb(255, 255, 255); display: block; height: 1px; font-size: 1px; margin-left: 2px; margin-right: 2px;"></span><span style="border-style: solid; border-color: rgb(238, 238, 238); border-width: 0px 1px; overflow: hidden; background-color: rgb(255, 255, 255); display: block; height: 1px; font-size: 1px; margin-left: 1px; margin-right: 1px;"></span><span style="border-style: solid; border-color: rgb(238, 238, 238); border-width: 0px 1px; overflow: hidden; background-color: rgb(255, 255, 255); display: block; height: 2px; font-size: 1px; margin-left: 0px; margin-right: 0px;"></span></div><div style="border-left: 1px solid rgb(238, 238, 238); border-right: 1px solid rgb(238, 238, 238);">
              <table class="news" id="news_table">
                <tr><td width="1%" nowrap valign="top"><span class="news_date">[<%= tz.utc_to_local(news.created_at).strftime("#{session[:user].time_format} #{session[:user].date_format}") %>]</span></td><td><span class="news_body" id="news_body"><%= news.body %></span></td><td align="right" width="1%" >
                <%= link_to_remote "[#{_('Hide')}]", :url => { :controller => 'users', :action => 'update_seen_news', :id => news.id },
                :success => visual_effect(:fade, "news", :duration => 0.5) %></td></tr>
              </table>
              </div><div style="background-color: rgb(238, 238, 238);"><span style="border-style: solid; border-color: rgb(238, 238, 238); border-width: 0px 1px; overflow: hidden; background-color: rgb(255, 255, 255); display: block; height: 2px; font-size: 1px; margin-left: 0px; margin-right: 0px;"></span><span style="border-style: solid; border-color: rgb(238, 238, 238); border-width: 0px 1px; overflow: hidden; background-color: rgb(255, 255, 255); display: block; height: 1px; font-size: 1px; margin-left: 1px; margin-right: 1px;"></span><span style="border-style: solid; border-color: rgb(238, 238, 238); border-width: 0px 1px; overflow: hidden; background-color: rgb(255, 255, 255); display: block; height: 1px; font-size: 1px; margin-left: 2px; margin-right: 2px;"></span><span style="border-color: rgb(238, 238, 238); border-width: 1px 2px 0px; border-top: 1px solid rgb(238, 238, 238); overflow: hidden; background-color: rgb(255, 255, 255); display: block; height: 0px; font-size: 1px; margin-left: 3px; margin-right: 3px;"></span></div></div>
              <br />
              </div>
            </div>
              <script type="text/javascript" language="javascript" charset="utf-8">
      new Effect.Highlight('news_table', {duration: 3.0});
              </script>

          <% end %>
          <% end %>

            <div id="flash" <%="style=\"display:none\"" unless flash['notice']%>>
              <div  class="rounded_content_body" style="margin-left: 4px; margin-right: 4px; padding-top: 0pt;"><div style="background-color: rgb(238, 238, 238);"><span style="border-color: rgb(238, 238, 238); border-width: 1px 2px 0px; border-top: 1px solid rgb(238, 238, 238); overflow: hidden; background-color: rgb(255, 255, 255); display: block; height: 0px; font-size: 1px; margin-left: 3px; margin-right: 3px;"></span><span style="border-style: solid; border-color: rgb(238, 238, 238); border-width: 0px 1px; overflow: hidden; background-color: rgb(255, 255, 255); display: block; height: 1px; font-size: 1px; margin-left: 2px; margin-right: 2px;"></span><span style="border-style: solid; border-color: rgb(238, 238, 238); border-width: 0px 1px; overflow: hidden; background-color: rgb(255, 255, 255); display: block; height: 1px; font-size: 1px; margin-left: 1px; margin-right: 1px;"></span><span style="border-style: solid; border-color: rgb(238, 238, 238); border-width: 0px 1px; overflow: hidden; background-color: rgb(255, 255, 255); display: block; height: 2px; font-size: 1px; margin-left: 0px; margin-right: 0px;"></span></div><div style="border-left: 1px solid rgb(238, 238, 238); border-right: 1px solid rgb(238, 238, 238);">
                <table class="flash" id="flash_body" style="padding-right:1em;"><tr><td id="flash_message"><%= @flash['notice'] %><br /></td><td width="1%" align=right><a href="#" onClick="Effect.Fade('flash'); return false;">[<%=_ 'Hide'%>]</a></td></tr></table>
              </div><div style="background-color: rgb(238, 238, 238);"><span style="border-style: solid; border-color: rgb(238, 238, 238); border-width: 0px 1px; overflow: hidden; background-color: rgb(255, 255, 255); display: block; height: 2px; font-size: 1px; margin-left: 0px; margin-right: 0px;"></span><span style="border-style: solid; border-color: rgb(238, 238, 238); border-width: 0px 1px; overflow: hidden; background-color: rgb(255, 255, 255); display: block; height: 1px; font-size: 1px; margin-left: 1px; margin-right: 1px;"></span><span style="border-style: solid; border-color: rgb(238, 238, 238); border-width: 0px 1px; overflow: hidden; background-color: rgb(255, 255, 255); display: block; height: 1px; font-size: 1px; margin-left: 2px; margin-right: 2px;"></span><span style="border-color: rgb(238, 238, 238); border-width: 1px 2px 0px; border-top: 1px solid rgb(238, 238, 238); overflow: hidden; background-color: rgb(255, 255, 255); display: block; height: 0px; font-size: 1px; margin-left: 3px; margin-right: 3px;"></span></div></div>
              <br />
              </div>
            </div>

      <% if flash['notice'] %>
              <script type="text/javascript" language="javascript" charset="utf-8">
      new Effect.Highlight('flash_body', {duration: 1.5});
              </script>
      <% end %>

          <div class="rounded_content_body" style="margin-left: 4px; margin-right: 4px; padding-top: 0pt;"><div style="background-color: rgb(238, 238, 238);"><span style="border-color: rgb(238, 238, 238); border-width: 1px 2px 0px; border-top: 1px solid rgb(238, 238, 238); overflow: hidden; background-color: rgb(255, 255, 255); display: block; height: 0px; font-size: 1px; margin-left: 3px; margin-right: 3px;"></span><span style="border-style: solid; border-color: rgb(238, 238, 238); border-width: 0px 1px; overflow: hidden; background-color: rgb(255, 255, 255); display: block; height: 1px; font-size: 1px; margin-left: 2px; margin-right: 2px;"></span><span style="border-style: solid; border-color: rgb(238, 238, 238); border-width: 0px 1px; overflow: hidden; background-color: rgb(255, 255, 255); display: block; height: 1px; font-size: 1px; margin-left: 1px; margin-right: 1px;"></span><span style="border-style: solid; border-color: rgb(238, 238, 238); border-width: 0px 1px; overflow: hidden; background-color: rgb(255, 255, 255); display: block; height: 2px; font-size: 1px; margin-left: 0px; margin-right: 0px;"></span></div><div style="border-left: 1px solid rgb(238, 238, 238); border-right: 1px solid rgb(238, 238, 238);">
          <table width="100%">
          <tr><td valign="top" id="main_col" style="height:100%;">
          <%= @content_for_layout %>
          </td><td align="right" valign="top" style="border-left: 1px solid #e8e8e8;" width="10%" id="left_menu">
            <table align="left" width="10%" class="projects" cellspacing=0 cellpadding=0>
              <tr>
                <td align="left" class="page_header"colspan="2" width="100%">
                  <div style="float: left;"><%=_ 'Views' %></div><div style="float:right;padding-top:0.1em;"><%= link_to _('New'),  :controller => 'views', :action => 'new' %></div></td>

                <tr><td class="views_item" style="padding-top: 0.2em;" colspan="2"><%= link_to "#{_('Open Tasks')}", :controller => 'views', :action => 'all_tasks'%></td></tr>
                <tr><td class="views_item" colspan="2"><%= link_to _('My Open Tasks'), :controller => 'views', :action => 'my_tasks'%></td></tr>
                <tr><td class="views_item" colspan="2"><%= link_to _('My In Progress Tasks'), :controller => 'views', :action => 'my_in_progress_tasks'%></td></tr>
                <tr><td class="views_item" colspan="2"><%= link_to _('Unassigned Tasks'), :controller => 'views', :action => 'unassigned_tasks'%></td></tr>
                <% project_ids = current_project_ids
                   views = View.find(:all, :conditions => ["company_id = ? AND (user_id = ? or shared = 1) AND (filter_project_id = 0 OR filter_project_id IS NULL OR filter_project_id IN (#{project_ids}))", session[:user].company_id, session[:user].id], :order => "shared, name")
                   for view in views %>
                <tr><td class="views_item"><%= link_to view.name, :controller => 'views', :action => 'select', :id => view %></td><td align="right"><%= link_to _('Edit'), :controller => 'views', :action => 'edit', :id => view if view.user_id == session[:user].id %><%= "[#{_('Shared')}]" if view.user_id != session[:user].id %></td></tr>
                   <% end %>
                <tr><td colspan=2>&nbsp;</td></tr>
        <% cache( :controller => "application", :action => "chat", :action_suffix => "#{session[:user].company_id}_#{session[:user].id}") do %>
                <tr>
                  <td align=left style="margin-bottom:4px;" class="page_header" colspan=2>
                    <%=_ 'Chat'%>
                  </td>
                </tr>
                <tr>
                  <td colspan=2 style="padding-top:0.5em;" id="shouts_container">
                  <ul id="shouts" class="shout" style="padding-left:0px;">
                  <% @shouts = Shout.find(:all, :conditions => ["shouts.company_id = ?", session[:user].company.id], :limit => 7, :order => "shouts.id desc", :include => "user" )%>
                  <%= render :partial => "shout/shouts", :locals => { :shouts => @shouts } %>
                  </ul>
                  </td>
                </tr>
                <tr><td colspan=2>
                        <%= text_field 'shout', 'body' %>
                <tr><td colspan=2>&nbsp;</td></tr>
        <% end %>
                <tr>
                  <td align=left class="page_header" width="100%" colspan="2">
                    <div style="float:left;"><%=_ 'Notes'%></div><div style="float:right;padding-top:0.1em;"><%= link_to _('New'), :controller => 'pages', :action => 'new' %></div></td>
                </tr>
                        <tr><td colspan="2"><div style="height:0.2em;"></div></td></tr>
          <% for page in current_pages %>
                <tr>
                  <td align=left class="pages_item" colspan=2><%= link_to "#{page.name} / #{page.project.name}", { :controller => 'pages', :action => 'show', :id => page} %> <small>(<%=_('%s ago', time_ago_in_words( page.updated_at, false ) )%>)</small></td>
                </tr>
          <% end %>
               <tr><td colspan=2>&nbsp;</td></tr>
              </table>
            </td></tr>
          </table>
          </div></td>
        </td>
      </tr>
    </table>
    <span class="contact">Clocking IT v0.99.1 - <%=_ 'Feedback? Suggestions? Ideas? Bugs?'%> <a href="mailto:feedback@clockingit.com"><%=_ 'Let me know'%></a> <%= link_to "[Admin]", :controller => "admin", :action => "index" if session[:user].admin == 10 %></span>

<%= periodically_call_remote(:url => { :controller => 'tasks', :action => 'update_sheet_info' }, :frequency => 90 ) -%>
<%#= periodically_call_remote(:url => { :controller => 'shout', :action => 'list_ajax' }, :frequency => 7, :complete => "check_chat(request);" ) -%>

<%= flash_plugin(session[:channels]) %>

<script type="text/javascript" language="javascript" charset="utf-8">
// <![CDATA[
var userId=<%=session[:user].id%>;
init_shout();
<% if session[:user].option_tooltips.nil? || session[:user].option_tooltips == 1 %>
makeTooltips(1);
<% else %>
makeTooltips(0);
<% end %>

// ]]>
</script>

</body>
</html>
